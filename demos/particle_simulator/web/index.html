<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Particle Life Simulation - Zig WebGPU FFI</title>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            background-color: #111; 
            height: 100%; 
            font-family: monospace;
            color: #eee;
        }
        canvas#zigCanvas { 
            display: block; 
            width: 100vw; 
            height: 100vh; 
        }
        
        .panel {
            background-color: rgba(50, 50, 50, 0.8);
            border-radius: 8px;
            border: 1px solid #666;
            color: #eee;
            padding: 12px;
            backdrop-filter: blur(4px);
            font-family: monospace;
            font-size: 12px;
            position: fixed;
            z-index: 1000;
        }

        #controlPanel {
            left: 12px;
            top: 12px;
            width: 250px;
        }

        #infoPanel {
            right: 12px;
            top: 12px;
            width: 200px;
        }

        .slider-container {
            margin: 8px 0;
        }

        .slider-container label {
            display: block;
            margin-bottom: 4px;
        }

        .slider-container input[type="range"] {
            width: 100%;
            margin: 2px 0;
        }

        .button-container {
            margin: 8px 0;
        }

        .button {
            background-color: #666;
            border: 1px solid #888;
            color: #eee;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
            font-family: monospace;
            font-size: 11px;
        }

        .button:hover {
            background-color: #777;
        }

        .button:active {
            background-color: #555;
        }

        .checkbox-container {
            margin: 6px 0;
        }

        .checkbox-container input {
            margin-right: 6px;
        }

        .value-display {
            color: #aaa;
            float: right;
        }

        h3 {
            margin: 0 0 8px 0;
            color: #fff;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="zigCanvas"></canvas>

    <!-- Control Panel -->
    <div id="controlPanel" class="panel">
        <h3>üß¨ Particle Life Controls</h3>
        
        <div class="slider-container">
            <label for="particleCount">Particles: <span class="value-display" id="particleCountValue">2048</span></label>
            <input type="range" id="particleCount" min="8" max="14" value="11" step="1">
        </div>

        <div class="slider-container">
            <label for="forceScale">Force Scale: <span class="value-display" id="forceScaleValue">0.001</span></label>
            <input type="range" id="forceScale" min="0" max="10" value="1" step="0.1">
        </div>

        <div class="slider-container">
            <label for="forceRange">Force Range: <span class="value-display" id="forceRangeValue">0.1</span></label>
            <input type="range" id="forceRange" min="0.05" max="0.5" value="0.1" step="0.01">
        </div>

        <div class="slider-container">
            <label for="friction">Friction: <span class="value-display" id="frictionValue">0.99</span></label>
            <input type="range" id="friction" min="0.9" max="1.0" value="0.99" step="0.001">
        </div>

        <div class="button-container">
            <button class="button" id="pauseBtn">‚è∏Ô∏è Pause</button>
            <button class="button" id="resetBtn">üîÑ Reset</button>
        </div>

        <div class="button-container">
            <button class="button" id="randomizeBtn">üé≤ Randomize Forces</button>
        </div>

        <div class="checkbox-container">
            <label>
                <input type="checkbox" id="showDebug"> Show Debug Info
            </label>
        </div>

        <div class="button-container">
            <button class="button" id="hideControlsBtn">üëÅÔ∏è Hide Controls</button>
        </div>
    </div>

    <!-- Info Panel -->
    <div id="infoPanel" class="panel">
        <h3>üìä Simulation Info</h3>
        <div>Species: <span id="speciesCount">4</span></div>
        <div>Frame: <span id="frameCount">0</span></div>
        <div>FPS: <span id="fpsDisplay">60</span></div>
        <div style="margin-top: 8px; font-size: 10px; color: #999;">
            üêÅ LMB: Attract particles<br>
            üêÅ RMB: Repel particles<br>
            üéØ Scroll: Zoom<br>
            ‚å®Ô∏è S: Toggle controls
        </div>
    </div>

    <script type="module" src="main.js"></script>

    <script>
        // Global variables for UI state
        let isPaused = false;
        let showDebug = false;
        let frameCount = 0;
        let lastTime = performance.now();
        let fps = 60;

        // Initialize UI controls
        function initializeControls() {
            // Update value displays
            function updateValueDisplay(sliderId, displayId, formatter = (v) => v) {
                const slider = document.getElementById(sliderId);
                const display = document.getElementById(displayId);
                display.textContent = formatter(slider.value);
                
                slider.addEventListener('input', () => {
                    display.textContent = formatter(slider.value);
                    updateSimulationParameter(sliderId, parseFloat(slider.value));
                });
            }

            updateValueDisplay('particleCount', 'particleCountValue', (v) => Math.pow(2, v));
            updateValueDisplay('forceScale', 'forceScaleValue', (v) => (v * 0.001).toFixed(4));
            updateValueDisplay('forceRange', 'forceRangeValue', (v) => parseFloat(v).toFixed(2));
            updateValueDisplay('friction', 'frictionValue', (v) => parseFloat(v).toFixed(3));

            // Button handlers
            document.getElementById('pauseBtn').addEventListener('click', togglePause);
            document.getElementById('resetBtn').addEventListener('click', resetSimulation);
            document.getElementById('randomizeBtn').addEventListener('click', randomizeForces);
            document.getElementById('hideControlsBtn').addEventListener('click', toggleControls);
            
            // Debug toggle
            document.getElementById('showDebug').addEventListener('change', (e) => {
                showDebug = e.target.checked;
                updateDebugVisibility();
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 's' || e.key === 'S') {
                    toggleControls();
                    e.preventDefault();
                }
                if (e.key === ' ') {
                    togglePause();
                    e.preventDefault();
                }
            });

            // Update frame counter
            updateFrameCounter();
        }

        function updateSimulationParameter(param, value) {
            // Will be implemented when we add parameter updates to WASM
            console.log(`Updating ${param} to ${value}`);
        }

        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('pauseBtn');
            btn.textContent = isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
            // TODO: Send pause command to WASM
        }

        function resetSimulation() {
            frameCount = 0;
            console.log('Reset simulation requested');
            // TODO: Send reset command to WASM
        }

        function randomizeForces() {
            console.log('Randomize forces requested');
            // TODO: Send randomize command to WASM
        }

        function toggleControls() {
            const controlPanel = document.getElementById('controlPanel');
            const infoPanel = document.getElementById('infoPanel');
            const hideBtn = document.getElementById('hideControlsBtn');
            
            if (controlPanel.classList.contains('hidden')) {
                controlPanel.classList.remove('hidden');
                infoPanel.classList.remove('hidden');
                hideBtn.textContent = 'üëÅÔ∏è Hide Controls';
            } else {
                controlPanel.classList.add('hidden');
                infoPanel.classList.add('hidden');
                hideBtn.textContent = 'üëÅÔ∏è Show Controls';
            }
        }

        function updateDebugVisibility() {
            // TODO: Toggle debug rendering
            console.log('Debug visibility:', showDebug);
        }

        function updateFrameCounter() {
            frameCount++;
            document.getElementById('frameCount').textContent = frameCount;

            // Calculate FPS
            const now = performance.now();
            if (now - lastTime >= 1000) {
                fps = Math.round(1000 / (now - lastTime) * (frameCount % 60));
                document.getElementById('fpsDisplay').textContent = fps;
                lastTime = now;
            }

            requestAnimationFrame(updateFrameCounter);
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeControls);

        // Make functions available globally for WASM integration
        window.particleLifeUI = {
            updateFrameCount: (count) => document.getElementById('frameCount').textContent = count,
            updateSpeciesCount: (count) => document.getElementById('speciesCount').textContent = count,
            updateFPS: (fps) => document.getElementById('fpsDisplay').textContent = fps,
            isPaused: () => isPaused,
            getParameters: () => ({
                particleCount: Math.pow(2, document.getElementById('particleCount').value),
                forceScale: parseFloat(document.getElementById('forceScale').value) * 0.001,
                forceRange: parseFloat(document.getElementById('forceRange').value),
                friction: parseFloat(document.getElementById('friction').value)
            })
        };
    </script>
</body>
</html>
